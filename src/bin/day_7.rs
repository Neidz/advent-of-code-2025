use std::collections::{HashMap, HashSet};

type Coordinates = (i32, i32);

#[derive(Debug)]
struct TachyonManifold {
    splitters: HashSet<Coordinates>,
    entrance: Coordinates,
    width: i32,
    height: i32,
}

impl TachyonManifold {
    pub fn new(input: &str) -> Self {
        let mut splitters = HashSet::new();
        let mut entrance: Option<Coordinates> = None;
        let mut width: Option<i32> = None;
        let mut height = 0i32;

        input.lines().enumerate().for_each(|(y, line)| {
            height += 1;
            if width.is_none() {
                width = Some(line.len() as i32);
            }
            line.chars().enumerate().for_each(|(x, token)| match token {
                'S' => {
                    entrance = Some((x as i32, y as i32));
                }
                '^' => {
                    splitters.insert((x as i32, y as i32));
                }
                _ => {}
            });
        });

        Self {
            splitters,
            entrance: entrance.unwrap(),
            width: width.unwrap(),
            height,
        }
    }
}

fn main() {
    part1();
    part2();
}

fn part1() {
    let manifold = TachyonManifold::new(INPUT);
    let mut beams: HashSet<(i32, i32)> = HashSet::new();
    let mut splits = 0usize;

    (0..manifold.height).for_each(|row| {
        if beams.is_empty() {
            beams.insert((manifold.entrance.0, manifold.entrance.1 + 1));
            return;
        }

        let beams_on_analyzed_row = beams
            .iter()
            .cloned()
            .filter(|(_, y)| *y == row)
            .collect::<Vec<Coordinates>>();

        beams_on_analyzed_row
            .iter()
            .cloned()
            .for_each(|(beam_x, beam_y)| {
                let hits_splitter = manifold.splitters.contains(&(beam_x, beam_y + 1));
                if !hits_splitter {
                    beams.insert((beam_x, beam_y + 1));
                    return;
                }

                splits += 1;

                let new_left_beam = (beam_x - 1, beam_y + 1);
                if new_left_beam.0 >= 0 {
                    beams.insert(new_left_beam);
                }
                let new_right_beam = (beam_x + 1, beam_y + 1);
                if new_right_beam.0 < manifold.width {
                    beams.insert(new_right_beam);
                }
            });
    });

    println!("Part1: beam was split: {} times", splits);
}

fn part2() {
    let manifold = TachyonManifold::new(INPUT);
    let mut already_traversed: HashMap<Coordinates, usize> = HashMap::new();
    let possible_timelines = traverse(
        (manifold.entrance.0, manifold.entrance.1 + 1),
        &manifold,
        &mut already_traversed,
    );

    println!("Part2: beam was in: {possible_timelines} timelines");
}

fn traverse(
    (beam_x, beam_y): Coordinates,
    manifold: &TachyonManifold,
    already_traversed: &mut HashMap<Coordinates, usize>,
) -> usize {
    let mut exits_from_children = 0;

    if beam_y == manifold.height - 1 {
        return 1;
    }

    if let Some(seen_exits) = already_traversed.get(&(beam_x, beam_y)) {
        return *seen_exits;
    }

    let hits_splitter = manifold.splitters.contains(&(beam_x, beam_y + 1));
    if !hits_splitter {
        exits_from_children += traverse((beam_x, beam_y + 1), manifold, already_traversed);
    } else {
        let new_left_beam = (beam_x - 1, beam_y + 1);
        if new_left_beam.0 >= 0 {
            let exits_from_left = traverse(new_left_beam, manifold, already_traversed);
            exits_from_children += exits_from_left;
            already_traversed.insert(new_left_beam, exits_from_left);
        }
        let new_right_beam = (beam_x + 1, beam_y + 1);
        if new_right_beam.0 < manifold.width {
            let exits_from_right = traverse(new_right_beam, manifold, already_traversed);
            exits_from_children += exits_from_right;
            already_traversed.insert(new_right_beam, exits_from_right);
        }
    }

    exits_from_children
}

const _TEST_INPUT: &str = ".......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............";

const INPUT: &str = "......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^.....^...................................................................
.............................................................................................................................................
..................................................................^.^.^...^..................................................................
.............................................................................................................................................
.................................................................^.^...^.^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.....^................................................................
.............................................................................................................................................
...............................................................^.^.^.......^.^...............................................................
.............................................................................................................................................
..............................................................^...^.^.^...^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^...^...^.^.............................................................
.............................................................................................................................................
............................................................^.^.^.^.^.^.^.....^.^............................................................
.............................................................................................................................................
...........................................................^.^.^.^.^...^.^...^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^...^...^...^.^.^.^.^.^..........................................................
.............................................................................................................................................
.........................................................^.^.^...^...^.^.^.^...^.^.^.........................................................
.............................................................................................................................................
........................................................^.^.....^.^.^.^.^.^.^.^.^...^........................................................
.............................................................................................................................................
.......................................................^...^.^.^.^.^.^...^.^.^.^.^.^.^.......................................................
.............................................................................................................................................
......................................................^...^.^...^.^.^.^.^.^.^.....^.^.^......................................................
.............................................................................................................................................
.....................................................^.....^.^.^.^.^.^.^.^.....^.^.^.^.^.....................................................
.............................................................................................................................................
....................................................^...^...^.^.^.^.^...^.^.^...^.^.^...^....................................................
.............................................................................................................................................
...................................................^...^.^.^.....^.^.^...^...^...^...^...^...................................................
.............................................................................................................................................
..................................................^.^...^.^.^.^.^.^...^.^...^.^.^...^.^...^..................................................
.............................................................................................................................................
.................................................^.^.......^...^.^.^.^.^.^...^...^.....^.^.^.................................................
.............................................................................................................................................
................................................^...^.^...^.^...^...^...^.^.^...^...^.^.^...^................................................
.............................................................................................................................................
...............................................^.^.^.^.^.^.^.^.^...^.^.^...^...^...^.^.^.^.^.^...............................................
.............................................................................................................................................
..............................................^.^.^.^.^.......^.....^...^.^.^...^.^...^.^.^...^..............................................
.............................................................................................................................................
.............................................^.^.......^.^.^...^.^...^.^.^.^.....^.^...^...^...^.............................................
.............................................................................................................................................
............................................^.....^.....^...^...^.^.^.^...^.^.....^.^...^.^.^.^.^............................................
.............................................................................................................................................
...........................................^.....^.^...^.^.^.^.^.^.....^.^.^...^...^.^.^...^.^.^.^...........................................
.............................................................................................................................................
..........................................^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.....^.......^.^.^.^...^..........................................
.............................................................................................................................................
.........................................^...^.^.^.^.^.^.......^.^.......^.....^.^.^.^.^...^.^.....^.........................................
.............................................................................................................................................
........................................^...^...^.^.^.^.^.^.^.^.^.....^.....^.^.^.^.....^...^.^.^.^.^........................................
.............................................................................................................................................
.......................................^.^.^...........^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^...^...^.^.......................................
.............................................................................................................................................
......................................^.^.^.^.^.^...........^.^.^.^.^.^.^.^.^...^.^.^.....^.^.^...^.^.^......................................
.............................................................................................................................................
.....................................^.^.^.......^...^.^.^...^.^.^.^.^.^.^.^.^.^.^.......^...^.^...^.^.^.....................................
.............................................................................................................................................
....................................^.^.^.^.^.^...^...^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^...^.^...^.^.^....................................
.............................................................................................................................................
...................................^.^...^.^.^.^.^...^.^.^.^...........^.^.....^.^...^.^.^.^.^.^.^.^.....^...................................
.............................................................................................................................................
..................................^.^...^.^.^.^.^.....^.^.^.^...^.......^.^.^...^...^.^.^.^.^.....^.....^.^..................................
.............................................................................................................................................
.................................^.^...^.^.^.^.^...^.^.^.^.^.^...^.^.^.....^.^.^.^...^...^.^...^.^.^.^...^.^.................................
.............................................................................................................................................
................................^...^.^.^...^.^.^.^.^.^.....^.^.^.^.^...^.^.^.^.^...^...^.^.^.^.^...^...^...^................................
.............................................................................................................................................
...............................^...^.^.....^...^.^.....^...^.^.^.^...^.^.^.^.^.........^...^.^.^.....^.^.....^...............................
.............................................................................................................................................
..............................^.^.^.^.^...^.^.^.^.^.........^...^...^...^...^.^.^.^...^.^.^...^.^.^...^.^.^.^.^..............................
.............................................................................................................................................
.............................^.^.^.^.^.^.....^...^.^.^.^.^.^.^.^...^.^.^.^.^...^...^.^.^.^.....^.^.....^...^...^.............................
.............................................................................................................................................
............................^.^.^.........^.^.^.^...^...^.^.^.....^.^.^.^.^...^.^.^.^.^.^.......^.^.^...^.^.^...^............................
.............................................................................................................................................
...........................^...^.^.^.^.^.^...^.^.^.^.^.......^.^.^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.^.^.^.^...^...........................
.............................................................................................................................................
..........................^.^.^.^.^.^.^.^...^.^.....^.....^.^.^.^.^.....^.^.^.^.^...^.....^.^...^.^.^...^...^.^.^.^..........................
.............................................................................................................................................
.........................^.^...^.^...^...^.^.^.^.^.^.^.^...^.^...^.^.^.^.....^.^...^.^.^.^...^.....^.^.^.^...^.^.^.^.........................
.............................................................................................................................................
........................^...^.^...^.^.^...^.^.....^.^...^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.....^...........^.^...^........................
.............................................................................................................................................
.......................^.^.^.....^...^.^.......^.^...^.^.^...^.^.^.^...^...^.^.^.^...^...^.^...^.....^...^.^.....^...^.......................
.............................................................................................................................................
......................^.^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.....^.^.^.....^...^.....^.^.....^...^.^.^...^.^...^.........^......................
.............................................................................................................................................
.....................^.^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.....^...^.^.^.^.^.^.^.^...^.^.^.^.^.^...^...^...^.^...^...^...^.....................
.............................................................................................................................................
....................^.....^...^...^.^.^...^.^.^.^.^...^.^...^.....^...^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.....^....................
.............................................................................................................................................
...................^.^.^.^.^.....^.........^.......^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.^...^.....^.^.^.^.^...^.^.^...^.^.^...................
.............................................................................................................................................
..................^.^...^...^.^.......^.^...^.^...^.^.....^.^...^.............^.^.^.......^...^.......^...^.^.....^.^.^.^.^..................
.............................................................................................................................................
.................^.^.^.^.^.^.^.^.^.......^.....^.^.^.^.^.......^.^.^.^.^.^...^.^...^...^.^.^...^.^...^...^.^.^.^...^.^.^.^.^.................
.............................................................................................................................................
................^...^.^.^.^...^...^.^...............^...^.....^...^.^.^.^.....^...^.^...^.....^...^.^...^.^.^.^.^...^.^.^.^.^................
.............................................................................................................................................
...............^.^...^.^.^.^...^.^.^.^.^.^.^.^.^...........^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.........^...^.^.^.^.^.^.^.^.^...............
.............................................................................................................................................
..............^.^.^.^.....^.^.^...^.^.^.^.^.....^.^.^...^.^.^.^.^.....^.^.^.^.^.^...^.^...^.^.^...^.^.^...^.^.^.......^.^.....^..............
.............................................................................................................................................
.............^.^.^.^.^.^...^...^.....^.^...^.^.^...^.^.^...^.^.^...^.^.^.^.^.^.^...^...^...^.....^.^...^.^.^.^.^.^...^.^...^...^.............
.............................................................................................................................................
............^.^.^...^.^...^.....^.^...^...^.^.^.^.....^.........^...^...^.^.^.^.^.^.^.^.^.^.^.....^...^.^.^.^.^.^...^.^.^.^.^...^............
.............................................................................................................................................
...........^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.......^.^.^...^.^.^...^.......^.^.........^...........
.............................................................................................................................................
..........^...^...^.^...^...^.^.^.^.^.......^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^.^...^.......^.^...^...^.^.^.^.^.......^.^...^..........
.............................................................................................................................................
.........^.^.^.^.^.^.^.^.......^.^.^...^.^.^.....^...^.^.^...^.......^.^.^.^.^.^...^.....^...^.^.............^.....^...^.^...^.^...^.........
.............................................................................................................................................
........^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^...^...^.^.^...^...^.^.^.^.......^.^.^.^.^.^.^.^.......^.^.^.^.....^.^...^.^.....^.^.^........
.............................................................................................................................................
.......^.^.^...^.....^.....^.....^...^...^.^.^.^.^.^...^...^...^.^...^.^.........^.^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.......
.............................................................................................................................................
......^...^.^.^.^.^...^.^.^.^.......^.^.....^.....^.^.^.^.^...^.^.^...^.^.^.^.^...^.^...^.^.....^.^.....^.^...^...^.^.^...^.^.^.^...^.^......
.............................................................................................................................................
.....^.^.^.....^.^.^.^.^.^.^.^.......^...^.^...........^.^.^...^.^.^.^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.....^...^.^...^...^...^...^.^.^.....
.............................................................................................................................................
....^...^...^.^...^.....^.^.^...^.^.^.^.^.^...^.^...^.....^.^.^.....^...^...^.^.^.^.^.^.^.^.^.....^.^.^.....^...^.^.^.^.^.....^...^.....^....
.............................................................................................................................................
...^...^...^.^.^.^.^.^.^.......^.^...^.^.^.....^.^.....^...^.^.....^.^.......^.^.^...^.^.^...^.^...^.^...^...^.^...^.^.^...^...^...^.....^...
.............................................................................................................................................
..^.^.^.^.^.....^.^.^.^.^.......^.^.....^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.......^.......^.....^.^...^.....^.^.^.^.^.^.^.^.^...^.^.^...^...^.^..
.............................................................................................................................................
.^.^.......^.^.^.^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^.^...^.^.......^.^.....^.^.^...^.^.....^.^.^.^.^.....^.^.^.^.^.^...^...^.^.^.
.............................................................................................................................................";
